{% extends "admin/base.html" %}

{% block title %}{% if article %}Edit Article{% else %}New Article{% endif %}{% endblock %}

{% block content %}
<div class="studio-container">
    <div class="studio-topbar">
        <div class="topbar-left">
            <span class="floating-badge">Article Studio</span>
            
        </div>
        <div class="topbar-actions">
            <button id="save-draft-btn" type="button" class="ghost">Save Draft</button>
            <button id="publish-btn" type="button" class="primary">
                {% if article and article.status == 'published' %}Update{% else %}Publish{% endif %}
            </button>
        </div>
    </div>

    

    <div class="studio-main">
        <aside class="studio-sidebar">
            <div class="sidebar-card">
                <div class="sidebar-card-header">
                    <h2>Document Structure</h2>
                    <button type="button" class="nav-add-button" id="nav-add-button">+ Add Section</button>
                </div>
                <div id="nav-tree" class="nav-tree"></div>
                <form id="nav-detail-form" class="nav-detail-form hidden">
                    <input type="hidden" id="nav-item-id">
                    <label>
                        <span>Label</span>
                        <input type="text" id="nav-label" required placeholder="Navigation label">
                    </label>
                    <label>
                        <span>Slug</span>
                        <input type="text" id="nav-slug" placeholder="identifier">
                    </label>
                    <label>
                        <span>URL</span>
                        <input type="text" id="nav-url" placeholder="/path or https://example.com">
                    </label>
                    <label>
                        <span>Section</span>
                        <input type="text" id="nav-section" list="section-options" placeholder="Section key">
                    </label>
                    <label class="checkbox-inline">
                        <input type="checkbox" id="nav-visible" checked>
                        <span>Visible</span>
                    </label>
                    <label class="checkbox-inline">
                        <input type="checkbox" id="nav-external">
                        <span>Open in new tab</span>
                    </label>
                    <div class="nav-form-actions">
                        <button type="button" data-action="cancel" class="nav-form-cancel">Cancel</button>
                        <button type="submit" class="nav-form-save">Save</button>
                    </div>
                </form>
            </div>

            <div class="sidebar-card">
                <h2>Custom Components</h2>
                <div class="component-list">
                    <button type="button" data-component="businessProcess">+ Service Blueprint</button>
                    <button type="button" data-component="maturityModel">+ Maturity Model</button>
                    <button type="button" data-component="processFlow">+ Transformation Map</button>
                </div>
            </div>
        </aside>

        <section class="studio-editor">
            <div class="editor-controls">
                <div class="studio-headline">
                    <textarea
                        id="article-title"
                        class="page-title-input"
                        placeholder="Give this story a compelling title"
                        autocomplete="off"
                        rows="2">{{ article.title if article else '' }}</textarea>
                    <textarea
                        id="article-subtitle"
                        class="page-subtitle-input"
                        placeholder="Add a refined subtitle to frame the narrative"
                        autocomplete="off"
                        rows="2">{{ article.subtitle if article else '' }}</textarea>
                
                    <div class="topbar-status">
                        <span>Status: <span id="status-label">{% if article %}{{ article.status|capitalize }}{% else %}Draft{% endif %}</span></span>
                        <span id="last-updated">
                            {% if article %}
                                Last updated {{ article.updated_at.strftime('%Y-%m-%d %H:%M') }}
                            {% else %}
                                Unsaved draft
                            {% endif %}
                        </span>
                        <span class="hidden" id="autosave-indicator">Saving…</span>

                    </div>
                </div>
            </div>
            <div class="editor-panels" id="editor-panels">
                <div class="editor-view-toggle">
                    <button type="button" class="mode-button active" data-mode="editor">Editor</button>
                    <button type="button" class="mode-button" data-mode="preview">Preview</button>
                </div>
                <div class="editor-pane" id="editor-pane">
                    <div id="editor-container" class="editor-canvas"></div>
                </div>
                <div class="preview-pane" id="preview-pane">
                    <div class="preview-heading">Live Preview</div>
                    <div class="article-prose" id="preview-content">
                        {% if article and article.content_type == 'editorjs' %}
                            {{ article.render_html()|safe }}
                        {% else %}
                            <p class="text-text-muted italic">Compose in the editor to see the story unfold here.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </section>

        <aside class="studio-meta-panel">
            <div class="meta-card">
                <label for="article-slug">Slug</label>
                <input
                    id="article-slug"
                    type="text"
                    placeholder="article-url-slug"
                    value="{{ article.slug if article else '' }}"
                    autocomplete="off">
                <p class="text-xs font-sans tracking-[0.24em] uppercase text-text-light mt-2">Leave blank to auto-generate from the title.</p>
            </div>

            <div class="meta-card" id="article-section-card">
                <label for="article-section">Section</label>
                <input
                    id="article-section"
                    type="text"
                    list="section-options"
                    placeholder="e.g. blog or tom_method"
                    value="{{ article.section if article else 'blog' }}">

                <div class="mt-4">
                    <label for="article-subsection" class="block text-sm font-medium text-text-muted uppercase tracking-[0.24em] mb-2">Subsection</label>
                    <input
                        id="article-subsection"
                        type="text"
                        placeholder="Optional subgroup (e.g. Case Studies)"
                        value="{{ article.subsection if article else '' }}">
                </div>

                <div class="mt-4">
                    <label for="article-featured-order" class="block text-sm font-medium text-text-muted uppercase tracking-[0.24em] mb-2">Featured Order</label>
                    <input
                        id="article-featured-order"
                        type="number"
                        placeholder="Ordering on landing pages"
                        value="{{ article.featured_order if article and article.featured_order is not none else '' }}">
                </div>

                <div id="tom-method-fields" class="mt-4 space-y-3 {% if not article or article.section != 'tom_method' %}hidden{% endif %}">
                    <div>
                        <label for="article-chapter-slug" class="block text-sm font-medium text-text-muted uppercase tracking-[0.24em] mb-2">Chapter Slug</label>
                        <input
                            id="article-chapter-slug"
                            type="text"
                            placeholder="e.g. 01-foundation"
                            value="{{ article.chapter_slug if article else '' }}">
                    </div>
                    <div>
                        <label for="article-chapter-order" class="block text-sm font-medium text-text-muted uppercase tracking-[0.24em] mb-2">Chapter Order</label>
                        <input
                            id="article-chapter-order"
                            type="number"
                            placeholder="Ordering within chapter"
                            value="{{ article.chapter_order if article and article.chapter_order is not none else '' }}">
                    </div>
                </div>
            </div>

            <div class="meta-card">
                <label for="article-status">Visibility</label>
                <select id="article-status">
                    <option value="draft" {% if not article or article.status == 'draft' %}selected{% endif %}>Draft</option>
                    <option value="published" {% if article and article.status == 'published' %}selected{% endif %}>Published</option>
                    <option value="archived" {% if article and article.status == 'archived' %}selected{% endif %}>Archived</option>
                </select>
            </div>

            <div class="meta-card">
                <label for="article-author">Author</label>
                <input
                    id="article-author"
                    type="text"
                    placeholder="Author name"
                    value="{{ article.author if article else '' }}">
            </div>

            <div class="meta-card">
                <label for="article-reading-time">Reading Time</label>
                <input
                    id="article-reading-time"
                    type="text"
                    placeholder="e.g. 5 min read"
                    value="{{ article.reading_time if article else '' }}">
            </div>

            <div class="meta-card">
                <label for="article-excerpt">Excerpt</label>
                <textarea
                    id="article-excerpt"
                    rows="3"
                    placeholder="A graceful summary that entices the reader">{{ article.excerpt if article else '' }}</textarea>
            </div>

            <div class="meta-card">
                <label for="article-meta-description">Meta Description</label>
                <textarea
                    id="article-meta-description"
                    rows="3"
                    placeholder="SEO description to appear in search results">{{ article.meta_description if article else '' }}</textarea>
            </div>

            {% if article %}
            <div class="meta-card">
                <label>Actions</label>
                <div class="flex flex-col gap-3">
                    {% if article.status == 'published' %}
                    {% if article.section == 'tom_method' %}
                        {% set live_url = '/tom-method/' + (article.chapter_slug or '') + '/' + article.slug %}
                    {% elif article.section == 'portfolio' %}
                        {% set live_url = '/portfolio/' + article.slug %}
                    {% elif article.section == 'blog' %}
                        {% set live_url = '/blog/' + article.slug %}
                    {% else %}
                        {% set live_url = '/' + article.slug %}
                    {% endif %}
                    <a href="{{ live_url }}" target="_blank"
                       class="text-center inline-flex items-center justify-center rounded-full border border-text-primary/20 px-4 py-2 font-sans text-xs tracking-[0.25em] uppercase text-text-secondary hover:text-text-primary transition-colors">
                        View Live ↗
                    </a>
                    {% endif %}
                    <button id="delete-btn"
                            type="button"
                            class="rounded-full border border-red-200 px-4 py-2 font-sans text-xs tracking-[0.25em] uppercase text-red-500 hover:bg-red-50 transition-colors">
                        Delete Article
                    </button>
                </div>
            </div>
            {% endif %}
        </aside>
    </div>
</div>

<datalist id="section-options"></datalist>

<!-- Delete Confirmation Modal -->
<div id="delete-modal" class="fixed inset-0 bg-text-primary/50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen px-6">
        <div class="admin-panel max-w-md w-full p-8 space-y-6">
            <h3 class="font-sans text-lg tracking-[0.24em] uppercase text-text-primary">Delete Article?</h3>
            <p class="text-text-secondary leading-relaxed">This action cannot be undone. The article and all of its content will be permanently removed.</p>
            <div class="flex gap-3">
                <button id="confirm-delete" type="button" class="flex-1 rounded-full border border-red-300 bg-red-500 text-white py-3 font-sans text-xs tracking-[0.3em] uppercase hover:bg-red-600 transition-colors">
                    Delete
                </button>
                <button id="cancel-delete" type="button" class="flex-1 rounded-full border border-border-subtle bg-white py-3 font-sans text-xs tracking-[0.3em] uppercase text-text-secondary hover:bg-cream transition-colors">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
class ArticleEditor {
    constructor() {
        this.articleId = {{ article.id if article else 'null' }};
        this.editor = null;
        this.autosaveInterval = null;
        this.previewTimeout = null;
        this.isDirty = false;
        this.previewMode = 'split';
        this.navigationItems = [];
        this.dragIndex = null;
        this.currentNavSelection = null;
    }

    async init() {
        await this.initEditor();
        await this.loadSectionOptions();
        await this.initNavigationPanel();
        this.setupEventListeners();
        this.setupPreviewControls();
        this.setupEditorToolbar();
        this.setupAutosave();

        if (this.articleId) {
            await this.loadArticle();
        }

        this.updatePreviewMeta();
        this.queuePreviewUpdate();
    }

    async initEditor() {
        if (typeof EditorJS === 'undefined') {
            document.getElementById('editor-container').innerHTML = '<div class="p-6 text-red-600">EditorJS failed to load. Please refresh the page.</div>';
            return;
        }

        const availableTools = {};
        if (typeof Header !== 'undefined') {
            availableTools.header = {
                class: Header,
                config: {
                    placeholder: 'Heading',
                    levels: [1, 2, 3, 4],
                    defaultLevel: 2
                }
            };
        }
        if (typeof List !== 'undefined') {
            availableTools.list = { class: List, inlineToolbar: ['link', 'bold', 'italic'] };
        }
        if (typeof Quote !== 'undefined') {
            availableTools.quote = {
                class: Quote,
                inlineToolbar: ['italic'],
                config: {
                    quotePlaceholder: 'A considered quotation…',
                    captionPlaceholder: 'Attribution'
                }
            };
        }
        if (typeof Delimiter !== 'undefined') {
            availableTools.delimiter = Delimiter;
        }
        if (typeof Table !== 'undefined') {
            availableTools.table = { class: Table, inlineToolbar: true };
        }
        if (typeof Code !== 'undefined') {
            availableTools.code = { class: Code, config: { placeholder: 'Write code...' } };
        }
        if (typeof Raw !== 'undefined') {
            availableTools.raw = { class: Raw, config: { placeholder: 'Embed HTML …' } };
        }

        this.editor = new EditorJS({
            holder: 'editor-container',
            autofocus: true,
            placeholder: 'Begin your draft and shape the narrative…',
            tools: availableTools,
            inlineToolbar: ['link', 'bold', 'italic'],
            onChange: () => {
                this.isDirty = true;
                this.queuePreviewUpdate();
                this.toggleAutosaveIndicator(true);
            }
        });

        await this.editor.isReady;
    }

    setupEventListeners() {
        const titleInput = document.getElementById('article-title');
        const slugInput = document.getElementById('article-slug');
        const subtitleInput = document.getElementById('article-subtitle');

        titleInput.addEventListener('input', () => {
            if (!slugInput.value || slugInput.dataset.auto === 'true') {
                slugInput.value = this.slugify(titleInput.value);
                slugInput.dataset.auto = 'true';
            }
            this.updatePreviewMeta();
        });

        subtitleInput.addEventListener('input', () => this.updatePreviewMeta());
        slugInput.addEventListener('input', () => { slugInput.dataset.auto = 'false'; });

        const authorInput = document.getElementById('article-author');
        const readingInput = document.getElementById('article-reading-time');
        const sectionInput = document.getElementById('article-section');
        const subsectionInput = document.getElementById('article-subsection');
        const featuredInput = document.getElementById('article-featured-order');
        const chapterSlugInput = document.getElementById('article-chapter-slug');
        const chapterOrderInput = document.getElementById('article-chapter-order');

        authorInput.addEventListener('input', () => this.updatePreviewMeta());
        readingInput.addEventListener('input', () => this.updatePreviewMeta());
        sectionInput.addEventListener('input', () => {
            this.isDirty = true;
            this.toggleSectionFields();
            this.updatePreviewMeta();
        });
        [subsectionInput, featuredInput, chapterSlugInput, chapterOrderInput].forEach((input) => {
            if (input) {
                input.addEventListener('input', () => {
                    this.isDirty = true;
                });
            }
        });

        document.getElementById('article-status').addEventListener('change', (event) => {
            this.updateStatusLabel(event.target.value);
            this.updatePreviewMeta();
        });

        document.getElementById('save-draft-btn').addEventListener('click', async () => {
            await this.save('draft');
        });

        document.getElementById('publish-btn').addEventListener('click', async () => {
            document.getElementById('article-status').value = 'published';
            await this.save('published');
        });

        document.addEventListener('keydown', (event) => {
            if ((event.metaKey || event.ctrlKey) && event.key.toLowerCase() === 's') {
                event.preventDefault();
                this.save('draft');
            }
        });

        {% if article %}
        document.getElementById('delete-btn').addEventListener('click', () => {
            document.getElementById('delete-modal').classList.remove('hidden');
        });
        document.getElementById('cancel-delete').addEventListener('click', () => {
            document.getElementById('delete-modal').classList.add('hidden');
        });
        document.getElementById('confirm-delete').addEventListener('click', () => this.deleteArticle());
        {% endif %}

        this.toggleSectionFields();
    }

    toggleSectionFields() {
        const sectionInput = document.getElementById('article-section');
        const tomFields = document.getElementById('tom-method-fields');
        if (!sectionInput || !tomFields) return;
        if (sectionInput.value === 'tom_method') {
            tomFields.classList.remove('hidden');
        } else {
            tomFields.classList.add('hidden');
        }
    }

    setupAutosave() {
        this.autosaveInterval = setInterval(async () => {
            if (this.articleId && this.isDirty) {
                await this.save('auto', false);
            }
        }, 30000);
    }

    async loadSectionOptions() {
        try {
            const response = await fetch('/api/articles/sections');
            if (!response.ok) {
                throw new Error('Failed to load sections');
            }
            const sections = await response.json();
            const datalist = document.getElementById('section-options');
            if (!datalist) return;
            datalist.innerHTML = '';
            sections.forEach((section) => {
                const option = document.createElement('option');
                option.value = section;
                datalist.appendChild(option);
            });
        } catch (error) {
            console.error('Failed to load sections', error);
        }
    }

    setupPreviewControls() {
        this.workspace = document.getElementById('editor-panels');
        this.editorPane = document.getElementById('editor-pane');
        this.previewPane = document.getElementById('preview-pane');
        this.modeButtons = document.querySelectorAll('.mode-button');

        this.modeButtons.forEach((button) => {
            button.addEventListener('click', () => {
                this.setPreviewMode(button.dataset.mode);
            });
        });

        this.setPreviewMode(this.previewMode || 'split');
    }

    setPreviewMode(mode) {
        this.previewMode = mode;
        if (!this.workspace || !this.editorPane || !this.previewPane) {
            return;
        }

        this.modeButtons.forEach((button) => {
            button.classList.toggle('active', button.dataset.mode === mode);
        });

        this.workspace.classList.remove('split-mode');
        this.editorPane.classList.remove('hidden');
        this.previewPane.classList.remove('hidden', 'visible');

        if (mode === 'editor') {
            this.previewPane.classList.add('hidden');
        } else if (mode === 'preview') {
            this.editorPane.classList.add('hidden');
            this.previewPane.classList.add('visible');
        } else {
            this.workspace.classList.add('split-mode');
            this.previewPane.classList.add('visible');
        }
    }

    setupEditorToolbar() {
        const toolbar = document.getElementById('block-toolbar');
        if (toolbar) {
            toolbar.querySelectorAll('button[data-block]').forEach((button) => {
                button.addEventListener('click', () => {
                    const type = button.dataset.block;
                    const options = {
                        level: Number(button.dataset.level) || undefined,
                        style: button.dataset.style
                    };
                    this.insertBlock(type, options);
                });
            });
        }

        document.querySelectorAll('[data-component]').forEach((button) => {
            button.addEventListener('click', () => {
                this.insertCustomComponent(button.dataset.component);
            });
        });
    }

    insertBlock(type, options = {}) {
        if (!this.editor) {
            return;
        }
        const data = {};
        if (type === 'header' && options.level) {
            data.level = options.level;
        }
        if (type === 'list') {
            data.style = options.style || 'unordered';
            data.items = ['List item'];
        }
        if (type === 'code') {
            data.code = data.code || '';
        }
        if (type === 'quote') {
            data.text = 'Quote text';
            data.caption = '';
        }
        this.editor.blocks.insert(type, data, undefined, undefined, true).then(() => {
            this.queuePreviewUpdate();
        }).catch((error) => {
            console.error('Failed to insert block', error);
        });
    }

    insertCustomComponent(type) {
        if (!this.editor) {
            return;
        }
        const presets = {
            businessProcess: {
                name: 'New Process',
                description: 'Describe the process goal and context.',
                owner: 'Process Owner',
                steps: [
                    { description: 'First step of the process.' },
                    { description: 'Second step to follow.' }
                ]
            },
            maturityModel: {
                domain: 'Capability Name',
                levels: [
                    { name: 'Level 1', description: 'Initial capability description.' },
                    { name: 'Level 2', description: 'Improved capability description.' }
                ]
            },
            processFlow: {
                title: 'Transformation Journey',
                steps: [
                    { text: 'Define vision and success metrics.' },
                    { text: 'Design operating model and capabilities.' },
                    { text: 'Implement and iterate.' }
                ]
            }
        };

        const payload = presets[type];
        if (!payload) {
            console.warn('Unknown custom component', type);
            return;
        }

        this.editor.blocks.insert(type, payload, undefined, undefined, true).then(() => {
            this.queuePreviewUpdate();
        }).catch((error) => {
            console.error('Failed to insert custom component', error);
        });
    }

    async initNavigationPanel() {
        this.navTree = document.getElementById('nav-tree');
        this.navForm = document.getElementById('nav-detail-form');
        this.navAddButton = document.getElementById('nav-add-button');
        this.navIdInput = document.getElementById('nav-item-id');
        this.navLabelInput = document.getElementById('nav-label');
        this.navSlugInput = document.getElementById('nav-slug');
        this.navUrlInput = document.getElementById('nav-url');
        this.navSectionInput = document.getElementById('nav-section');
        this.navVisibleInput = document.getElementById('nav-visible');
        this.navExternalInput = document.getElementById('nav-external');

        if (!this.navTree || !this.navAddButton || !this.navForm) {
            return;
        }

        await this.loadNavigationItems();
        this.renderNavigationTree();

        this.navAddButton.addEventListener('click', () => {
            this.showNavForm();
        });

        this.navForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            await this.saveNavItem();
        });

        const cancelButton = this.navForm.querySelector('[data-action="cancel"]');
        if (cancelButton) {
            cancelButton.addEventListener('click', () => {
                this.navForm.classList.add('hidden');
                this.currentNavSelection = null;
                this.renderNavigationTree();
            });
        }

        this.navTree.addEventListener('click', (event) => {
            const action = event.target.dataset.action;
            if (!action) return;
            const node = event.target.closest('.nav-node');
            if (!node) return;
            const index = Number(node.dataset.index);
            const item = this.navigationItems[index];
            if (!item) return;

            if (action === 'edit') {
                this.showNavForm(item);
            } else if (action === 'delete') {
                this.deleteNavItem(item);
            }
        });
    }

    async loadNavigationItems() {
        try {
            const response = await fetch('/api/navigation');
            if (!response.ok) {
                throw new Error('Failed to load navigation');
            }
            this.navigationItems = await response.json();
        } catch (error) {
            console.error('Failed to load navigation', error);
            this.navigationItems = [];
        }
    }

    renderNavigationTree() {
        if (!this.navTree) return;

        if (!this.navigationItems.length) {
            this.navTree.innerHTML = '<div class="nav-empty">Add links to populate your header navigation.</div>';
            return;
        }

        this.navTree.innerHTML = this.navigationItems.map((item, index) => `
            <div class="nav-node ${item.id === this.currentNavSelection ? 'active' : ''}" data-id="${item.id}" data-index="${index}" draggable="true">
                <div class="nav-node-label">${item.label}</div>
                <div class="nav-node-actions">
                    <button type="button" data-action="edit">Edit</button>
                    <button type="button" data-action="delete">Delete</button>
                </div>
            </div>
        `).join('');

        this.attachNavDragEvents();
    }

    attachNavDragEvents() {
        const nodes = this.navTree.querySelectorAll('.nav-node');
        nodes.forEach((node) => {
            node.addEventListener('dragstart', (event) => {
                this.dragIndex = Number(event.currentTarget.dataset.index);
                event.dataTransfer.effectAllowed = 'move';
                event.dataTransfer.setData('text/plain', String(this.dragIndex));
                event.currentTarget.classList.add('dragging');
            });
            node.addEventListener('dragend', (event) => {
                event.currentTarget.classList.remove('dragging');
                this.dragIndex = null;
            });
            node.addEventListener('dragover', (event) => {
                event.preventDefault();
            });
            node.addEventListener('drop', (event) => {
                event.preventDefault();
                const targetIndex = Number(event.currentTarget.dataset.index);
                if (this.dragIndex === null || targetIndex === this.dragIndex) {
                    return;
                }
                this.reorderNavigation(this.dragIndex, targetIndex);
            });
        });
    }

    showNavForm(item = null) {
        if (!this.navForm) return;
        this.navForm.classList.remove('hidden');
        if (item) {
            this.currentNavSelection = item.id;
            this.navIdInput.value = item.id;
            this.navLabelInput.value = item.label || '';
            this.navSlugInput.value = item.slug || '';
            this.navUrlInput.value = item.url || '';
            this.navSectionInput.value = item.section || '';
            this.navVisibleInput.checked = item.is_visible !== false;
            this.navExternalInput.checked = !!item.is_external;
        } else {
            this.currentNavSelection = null;
            this.navIdInput.value = '';
            this.navLabelInput.value = '';
            this.navSlugInput.value = '';
            this.navUrlInput.value = '';
            this.navSectionInput.value = '';
            this.navVisibleInput.checked = true;
            this.navExternalInput.checked = false;
        }
        this.renderNavigationTree();
        if (this.navLabelInput) {
            this.navLabelInput.focus();
        }
    }

    async saveNavItem() {
        const payload = {
            label: this.navLabelInput.value.trim(),
            slug: this.navSlugInput.value.trim(),
            url: this.navUrlInput.value.trim(),
            section: this.navSectionInput.value.trim(),
            is_visible: this.navVisibleInput.checked,
            is_external: this.navExternalInput.checked
        };

        if (!payload.slug) payload.slug = null;
        if (!payload.url) payload.url = null;
        if (!payload.section) payload.section = null;

        if (!payload.label) {
            showNotification('Label is required', 'error');
            return;
        }

        const id = this.navIdInput.value;
        const endpoint = id ? `/api/navigation/${id}` : '/api/navigation';
        const method = id ? 'PUT' : 'POST';

        try {
            const response = await fetch(endpoint, {
                method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!response.ok) {
                throw new Error('Failed to save navigation item');
            }
            await this.loadNavigationItems();
            this.navForm.classList.add('hidden');
            this.currentNavSelection = null;
            this.renderNavigationTree();
            showNotification('Navigation updated', 'success');
        } catch (error) {
            console.error(error);
            showNotification('Failed to save navigation item', 'error');
        }
    }

    async deleteNavItem(item) {
        if (!item || !confirm('Delete this navigation item?')) {
            return;
        }
        try {
            const response = await fetch(`/api/navigation/${item.id}`, {
                method: 'DELETE'
            });
            if (!response.ok) {
                throw new Error('Failed to delete navigation item');
            }
            await this.loadNavigationItems();
            if (this.navForm) {
                this.navForm.classList.add('hidden');
            }
            this.currentNavSelection = null;
            this.renderNavigationTree();
            showNotification('Navigation item removed', 'success');
        } catch (error) {
            console.error(error);
            showNotification('Failed to delete navigation item', 'error');
        }
    }

    async reorderNavigation(fromIndex, toIndex) {
        if (fromIndex === toIndex) {
            return;
        }
        const items = this.navigationItems.slice();
        const [moved] = items.splice(fromIndex, 1);
        items.splice(toIndex, 0, moved);
        this.navigationItems = items.map((item, index) => ({ ...item, position: index }));

        try {
            await Promise.all(this.navigationItems.map((item) => {
                return fetch(`/api/navigation/${item.id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ position: item.position })
                }).then((response) => {
                    if (!response.ok) {
                        throw new Error('Failed to update position');
                    }
                });
            }));
            await this.loadNavigationItems();
            this.renderNavigationTree();
        } catch (error) {
            console.error('Failed to reorder navigation', error);
            showNotification('Failed to reorder navigation', 'error');
        }
    }

    async loadArticle() {
        try {
            const response = await fetch(`/api/articles/${this.articleId}`);
            const article = await response.json();

            if (article.content && article.content_type === 'editorjs') {
                await this.editor.render(article.content);
            }

            const sectionInput = document.getElementById('article-section');
            const subsectionInput = document.getElementById('article-subsection');
            const featuredInput = document.getElementById('article-featured-order');
            const chapterSlugInput = document.getElementById('article-chapter-slug');
            const chapterOrderInput = document.getElementById('article-chapter-order');

            if (sectionInput) {
                sectionInput.value = article.section || 'blog';
            }
            if (subsectionInput) {
                subsectionInput.value = article.subsection || '';
            }
            if (featuredInput) {
                featuredInput.value = article.featured_order !== null && article.featured_order !== undefined ? article.featured_order : '';
            }
            if (chapterSlugInput) {
                chapterSlugInput.value = article.chapter_slug || '';
            }
            if (chapterOrderInput) {
                chapterOrderInput.value = article.chapter_order !== null && article.chapter_order !== undefined ? article.chapter_order : '';
            }

            this.toggleSectionFields();

            this.updatePreviewMeta(article);
            this.queuePreviewUpdate();
        } catch (error) {
            console.error('Error loading article', error);
            window.showNotification('Failed to load article content', 'error');
        }
    }

    async save(status = 'draft', showNotification = true) {
        try {
            this.toggleAutosaveIndicator(true);
            const outputData = await this.editor.save();

            const sectionValue = document.getElementById('article-section').value || 'blog';
            const subsectionValue = document.getElementById('article-subsection').value;
            const featuredRaw = document.getElementById('article-featured-order').value;
            const chapterSlugValue = document.getElementById('article-chapter-slug').value;
            const chapterOrderRaw = document.getElementById('article-chapter-order').value;
            const featuredOrder = parseInt(featuredRaw, 10);
            const chapterOrder = parseInt(chapterOrderRaw, 10);

            const articleData = {
                title: document.getElementById('article-title').value,
                subtitle: document.getElementById('article-subtitle').value,
                slug: document.getElementById('article-slug').value,
                author: document.getElementById('article-author').value,
                reading_time: document.getElementById('article-reading-time').value,
                excerpt: document.getElementById('article-excerpt').value,
                meta_description: document.getElementById('article-meta-description').value,
                status: status === 'auto' ? document.getElementById('article-status').value : status,
                section: sectionValue,
                subsection: subsectionValue || null,
                featured_order: Number.isNaN(featuredOrder) ? null : featuredOrder,
                chapter_slug: chapterSlugValue || null,
                chapter_order: Number.isNaN(chapterOrder) ? null : chapterOrder,
                content_type: 'editorjs',
                content: outputData
            };

            const response = await fetch(this.articleId ? `/api/articles/${this.articleId}` : '/api/articles', {
                method: this.articleId ? 'PUT' : 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(articleData)
            });

            if (!response.ok) {
                throw new Error('Failed to save article');
            }

            const savedArticle = await response.json();

            if (!this.articleId) {
                this.articleId = savedArticle.id;
                history.pushState({}, '', `/admin/articles/${savedArticle.id}`);
            }

            const sectionSelect = document.getElementById('article-section');
            const subsectionInput = document.getElementById('article-subsection');
            const featuredInput = document.getElementById('article-featured-order');
            const chapterSlugInput = document.getElementById('article-chapter-slug');
            const chapterOrderInput = document.getElementById('article-chapter-order');

            if (sectionSelect) {
                sectionSelect.value = savedArticle.section || sectionSelect.value;
            }
            if (subsectionInput) {
                subsectionInput.value = savedArticle.subsection || '';
            }
            if (featuredInput) {
                featuredInput.value = savedArticle.featured_order !== null && savedArticle.featured_order !== undefined ? savedArticle.featured_order : '';
            }
            if (chapterSlugInput) {
                chapterSlugInput.value = savedArticle.chapter_slug || '';
            }
            if (chapterOrderInput) {
                chapterOrderInput.value = savedArticle.chapter_order !== null && savedArticle.chapter_order !== undefined ? savedArticle.chapter_order : '';
            }
            this.toggleSectionFields();

            document.getElementById('article-status').value = savedArticle.status;
            this.updateStatusLabel(savedArticle.status);
            this.isDirty = false;
            this.toggleAutosaveIndicator(false);
            this.updatePreviewMeta(savedArticle);
            const lastUpdated = document.getElementById('last-updated');
            if (lastUpdated && savedArticle.updated_at) {
                const updatedDate = new Date(savedArticle.updated_at);
                lastUpdated.textContent = `Last updated ${updatedDate.toLocaleString()}`;
            }

            if (showNotification) {
                const message = savedArticle.status === 'published' ? 'Article published!' : 'Draft saved';
                window.showNotification(message, 'success');
            }

            this.queuePreviewUpdate();
            return savedArticle;
        } catch (error) {
            console.error('Save error:', error);
            if (showNotification) {
                window.showNotification('Failed to save article', 'error');
            }
            this.toggleAutosaveIndicator(false);
            throw error;
        }
    }

    updateStatusLabel(status) {
        const statusLabel = document.getElementById('status-label');
        const previewStatus = document.getElementById('preview-meta-status');
        const pretty = status.charAt(0).toUpperCase() + status.slice(1);
        statusLabel.textContent = pretty;
        previewStatus.textContent = pretty;
    }

    formatSection(section) {
        const mapping = {
            blog: 'Articles',
            tom_method: 'The TOM Method',
            portfolio: 'Portfolio',
            home: 'Homepage'
        };
        if (!section) {
            return mapping.blog;
        }
        if (mapping[section]) {
            return mapping[section];
        }
        return section
            .split('_')
            .map((part) => part.charAt(0).toUpperCase() + part.slice(1))
            .join(' ');
    }

    updatePreviewMeta(article = null) {
        const data = article || {
            title: document.getElementById('article-title').value,
            subtitle: document.getElementById('article-subtitle').value,
            author: document.getElementById('article-author').value,
            reading_time: document.getElementById('article-reading-time').value,
            status: document.getElementById('article-status').value,
            section: document.getElementById('article-section').value
        };

        document.getElementById('preview-title').textContent = data.title || 'Start writing to see the preview…';
        document.getElementById('preview-subtitle').textContent = data.subtitle || 'Subtitles appear here as thoughtful context for the reader.';
        document.getElementById('preview-meta-author').textContent = data.author || 'Author';
        document.getElementById('preview-meta-reading').textContent = data.reading_time || 'Reading time';
        document.getElementById('preview-meta-status').textContent = data.status ? data.status.charAt(0).toUpperCase() + data.status.slice(1) : 'Draft';
        const previewSection = document.getElementById('preview-meta-section');
        if (previewSection) {
            previewSection.textContent = this.formatSection(data.section);
        }
    }

    queuePreviewUpdate() {
        if (!this.editor) return;
        clearTimeout(this.previewTimeout);
        this.previewTimeout = setTimeout(() => this.renderPreview(), 400);
    }

    async renderPreview() {
        if (!this.editor) return;

        try {
            const outputData = await this.editor.save();
            const html = this.renderBlocks(outputData.blocks || []);
            const previewContent = document.getElementById('preview-content');
            previewContent.innerHTML = html || '<p class="text-text-muted italic">Compose in the editor to see the story unfold here.</p>';
        } catch (error) {
            console.error('Preview render error:', error);
        }
    }

    renderBlocks(blocks) {
        return blocks.map((block) => {
            const data = block.data || {};
            switch (block.type) {
                case 'header':
                    return `<h${data.level || 2} class="font-sans font-semibold text-text-primary mt-12 mb-6 tracking-tight">${data.text || ''}</h${data.level || 2}>`;
                case 'paragraph':
                    return `<p class="leading-relaxed mb-6 text-text-primary">${data.text || ''}</p>`;
                case 'list':
                    const tag = data.style === 'ordered' ? 'ol' : 'ul';
                    const items = (data.items || []).map(item => `<li class="mb-2">${item}</li>`).join('');
                    return `<${tag} class="pl-8 my-6 space-y-2">${items}</${tag}>`;
                case 'quote':
                    return `<blockquote class="border-l-2 border-border-subtle pl-6 italic text-text-secondary mb-8">${data.text || ''}${data.caption ? `<cite class="not-italic block mt-4 text-xs uppercase tracking-[0.3em] text-text-light">— ${data.caption}</cite>` : ''}</blockquote>`;
                case 'code':
                    return `<pre class="bg-text-primary text-white rounded-2xl p-6 text-sm overflow-auto"><code>${data.code || ''}</code></pre>`;
                case 'delimiter':
                    return `<hr class="my-12 border-border-subtle">`;
                case 'table':
                    const rows = (data.content || []).map((row, index) => {
                        const cells = (row || []).map(cell => `<${index === 0 && data.withHeadings ? 'th' : 'td'}>${cell}</${index === 0 && data.withHeadings ? 'th' : 'td'}>`).join('');
                        return `<tr>${cells}</tr>`;
                    }).join('');
                    return `<div class="overflow-x-auto my-8"><table>${rows}</table></div>`;
                default:
                    return '';
            }
        }).join('');
    }

    toggleAutosaveIndicator(isSaving) {
        const indicator = document.getElementById('autosave-indicator');
        if (!indicator) return;
        indicator.classList.toggle('hidden', !isSaving);
    }

    async deleteArticle() {
        if (!this.articleId) return;
        try {
            const response = await fetch(`/api/articles/${this.articleId}`, { method: 'DELETE' });
            if (!response.ok) throw new Error();
            window.showNotification('Article deleted', 'success');
            setTimeout(() => { window.location.href = '/admin/articles'; }, 800);
        } catch (error) {
            window.showNotification('Failed to delete article', 'error');
        } finally {
            document.getElementById('delete-modal').classList.add('hidden');
        }
    }

    slugify(text) {
        return text
            .toLowerCase()
            .trim()
            .replace(/[^\w\s-]/g, '')
            .replace(/[\s_-]+/g, '-')
            .replace(/^-+|-+$/g, '');
    }
}

document.addEventListener('DOMContentLoaded', async () => {
    const editor = new ArticleEditor();
    await editor.init();
});
</script>
{% endblock %}
