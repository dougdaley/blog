{% extends "base.html" %}

{% block title %}{{ article.title }} - The TOM Method - My Personal Website{% endblock %}

{% block content %}
<!-- Reading Progress Bar -->
<div class="fixed top-0 left-0 h-0.5 bg-text-primary z-50 transition-all duration-100" id="reading-progress"></div>

<div class="max-w-4xl mx-auto px-8 py-12">
    <!-- Breadcrumb Navigation -->
    <nav class="mb-12 text-sm text-text-muted font-sans tracking-wide">
        <a href="/tom-method" class="hover:border-b hover:border-text-muted transition-all">← The TOM Method</a>
        {% if article.chapter %}
            <span class="mx-2">→</span>
            <span>{{ article.chapter.title }}</span>
            <span class="mx-2">→</span>
            <span class="text-text-secondary">{{ article.title }}</span>
        {% endif %}
    </nav>
    
    <div class="grid lg:grid-cols-[1fr_240px] gap-16">
        <article class="max-w-reading">
            <header class="mb-16 pb-8 border-b border-border-subtle">
                <h1 class="text-5xl font-sans font-bold text-text-primary mb-6 leading-tight tracking-tight">
                    {{ article.title }}
                </h1>
                
                {% if article.subtitle %}
                    <div class="text-xl text-text-secondary mb-12 leading-relaxed italic border-l-2 border-border-subtle pl-8 ml-4">
                        {{ article.subtitle }}
                    </div>
                {% endif %}
                
                <div class="flex gap-8 text-sm text-text-muted font-sans">
                    {% if article.chapter %}
                        <span>Chapter {{ article.chapter.number }}: {{ article.chapter.title }}</span>
                    {% endif %}
                    {% if article.reading_time %}
                        <span>{{ article.reading_time }}</span>
                    {% endif %}
                </div>
            </header>
            
            <div class="prose prose-lg max-w-none" id="article-content">
                {{ article.content|safe }}
            </div>
        </article>
        
        <aside class="sticky top-36 h-fit">
            <div class="border-l-2 border-border-subtle pl-6">
                <h3 class="text-sm font-medium text-text-muted font-sans tracking-wide uppercase mb-5">Contents</h3>
                <nav id="table-of-contents" class="space-y-3">
                    <!-- TOC will be populated by JavaScript -->
                </nav>
            </div>
        </aside>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const content = document.getElementById('article-content');
    const toc = document.getElementById('table-of-contents');
    const progressBar = document.getElementById('reading-progress');
    const headings = content.querySelectorAll('h2');
    
    // Generate table of contents
    if (headings.length > 0) {
        headings.forEach((heading, index) => {
            const id = 'heading-' + index;
            heading.id = id;
            
            const link = document.createElement('a');
            link.href = '#' + id;
            link.textContent = heading.textContent;
            link.className = 'block text-sm text-text-muted hover:text-text-primary transition-colors font-sans toc-link';
            
            toc.appendChild(link);
        });
        
        // Smooth scrolling for TOC links
        const tocLinks = document.querySelectorAll('.toc-link');
        tocLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            });
        });
        
        // Active heading tracking
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                const id = entry.target.getAttribute('id');
                const tocLink = document.querySelector(`a[href="#${id}"]`);
                
                if (entry.isIntersecting) {
                    tocLinks.forEach(link => link.classList.remove('text-text-primary', 'font-medium'));
                    tocLinks.forEach(link => link.classList.add('text-text-muted'));
                    if (tocLink) {
                        tocLink.classList.remove('text-text-muted');
                        tocLink.classList.add('text-text-primary', 'font-medium');
                    }
                }
            });
        }, {
            rootMargin: '-20% 0% -35% 0%'
        });
        
        headings.forEach(heading => observer.observe(heading));
        
    } else {
        toc.innerHTML = '<p class="text-sm text-text-light italic font-sans">No sections found</p>';
    }
    
    // Reading progress indicator
    function updateReadingProgress() {
        const article = document.querySelector('article');
        const articleTop = article.offsetTop;
        const articleHeight = article.offsetHeight;
        const windowTop = window.pageYOffset;
        const windowHeight = window.innerHeight;
        
        const progress = Math.min(
            Math.max((windowTop - articleTop + windowHeight * 0.1) / articleHeight, 0), 
            1
        );
        
        progressBar.style.width = `${progress * 100}%`;
    }
    
    let ticking = false;
    function onScroll() {
        if (!ticking) {
            requestAnimationFrame(() => {
                updateReadingProgress();
                ticking = false;
            });
            ticking = true;
        }
    }
    
    window.addEventListener('scroll', onScroll);
    updateReadingProgress();
});
</script>

<style>
/* Basic prose styling for markdown content */
.prose h2 {
    @apply text-3xl font-sans font-medium text-text-primary mt-16 mb-8 leading-tight tracking-tight;
}
.prose h3 {
    @apply text-xl font-sans font-medium text-text-primary mt-12 mb-6;
}
.prose p {
    @apply mb-6 text-text-primary leading-relaxed;
}
.prose ul, .prose ol {
    @apply my-8 pl-8;
}
.prose li {
    @apply mb-4 leading-relaxed;
}
.prose blockquote {
    @apply border-l-2 border-border-subtle pl-8 my-8 italic text-text-secondary text-lg;
}
.prose a {
    @apply text-text-primary underline underline-offset-2 hover:underline-offset-4 transition-all;
}
.prose code {
    @apply bg-cream text-red-600 px-2 py-1 rounded text-sm font-mono;
}
.prose pre {
    @apply bg-cream border border-border-subtle rounded p-6 my-8 overflow-x-auto;
}
.prose pre code {
    @apply bg-transparent text-text-secondary p-0;
}
</style>
{% endblock %}